// --------------------------------------------------
// GLOBALE VARIABLER
// --------------------------------------------------
let map;
let allCabins = [];
let allPlaces = [];
let searchIndex = [];
let suggestionActiveIndex = -1;

// --------------------------------------------------
// IKONER
// --------------------------------------------------
const cabinIcon = L.icon({
  iconUrl: "/image/cabin16.png",
  iconSize: [18, 18],
  iconAnchor: [12, 18],
  popupAnchor: [0, -18],
});

// Basiskart (lys, moderne)
const positronLayer = L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
  {
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
    subdomains: "abcd",
    maxZoom: 19,
  }
);

// --------------------------------------------------
// INIT â€“ Kalles nÃ¥r skriptet lastes
// --------------------------------------------------
initMap();
loadData();
initSearch();
initPrices();
setRandomFact();

// --------------------------------------------------
// KART (Leaflet)
// --------------------------------------------------
function initMap() {
  if (map) {
    map.remove();
  }

  map = L.map("map", {
    center: [62.501432, 7.1444801], // Tresfjord
    zoom: 8,
    layers: [positronLayer],
  });

  console.log("Kart initialisert");
}

// Hjelpefunksjon: hent lat/lon fra et "sted" (tettsted/hytte)
function getLatLon(obj) {
  const lat =
    typeof obj.lat === "number"
      ? obj.lat
      : typeof obj.latitude === "number"
      ? obj.latitude
      : typeof obj.h_lot === "number"
      ? obj.h_lot
      : null;

  const lon =
    typeof obj.lon === "number"
      ? obj.lon
      : typeof obj.longitude === "number"
      ? obj.longitude
      : typeof obj.h_lon === "number"
      ? obj.h_lon
      : null;

  if (typeof lat === "number" && typeof lon === "number") {
    return { lat, lon };
  }
  return null;
}

// --------------------------------------------------
// DATAINNLESING
// --------------------------------------------------
async function loadData() {
  try {
    const [tettstederResp, hytterResp, faktaResp] = await Promise.all([
      fetch("tettsteder_3.json"),
      fetch("dnt_hytter.json"),
      fetch("facts_all.json"),
    ]);

    const tettstederData = await tettstederResp.json();
    const hytterData = await hytterResp.json();
    const faktaData = await faktaResp.json(); // forelÃ¸pig ikke brukt, men klart

    allPlaces = Array.isArray(tettstederData) ? tettstederData : [];
    allCabins = Array.isArray(hytterData) ? hytterData : [];

    console.log("âœ… Tettsteder lastet:", allPlaces.length);
    console.log("âœ… Hytter lastet:", allCabins.length);

    buildSearchIndex();
    visAlleSteder();
  } catch (err) {
    console.error("ðŸš¨ Klarte ikke Ã¥ laste data:", err);
  }
}

// --------------------------------------------------
// VIS ALLE STEDER PÃ… KARTET
// --------------------------------------------------
function visAlleSteder() {
  if (!Array.isArray(allPlaces)) {
    console.warn("allPlaces er ikke en array:", allPlaces);
    return;
  }

  allPlaces.forEach((p) => {
    const coords = getLatLon(p);
    if (!coords) return;

    const navn = p.name || p.title || p.navn || "Uten navn";

    const marker = L.marker([coords.lat, coords.lon]).addTo(map);
    marker.bindPopup(navn);

    // Klikk pÃ¥ markÃ¸r â†’ infoboks
    marker.on("click", () => {
      showInfo(p);
    });
  });

  console.log("Viste alle steder pÃ¥ kartet:", allPlaces.length);
}

// --------------------------------------------------
// STRÃ˜MPRISER / RANDOM FACT â€“ STUBS
// --------------------------------------------------
async function initPrices() {
  // Her kan du hente strÃ¸mpriser og oppdatere #power-price senere
  console.log("initPrices: stub");
}

function setRandomFact() {
  const facts = [
    "Visste du at Norge har over 400 000 hytter?",
    "MÃ¸re og Romsdal har noen av de fineste fjordene i verden.",
    "Tresfjordbrua kortet ned reisetida mellom Vestnes og Ã…lesund betydelig.",
  ];
  const fact = facts[Math.floor(Math.random() * facts.length)];
  const factEl = document.getElementById("random-fact");
  if (factEl) factEl.textContent = fact;
}

// --------------------------------------------------
// SÃ˜KEINDEKS
// --------------------------------------------------
function buildSearchIndex() {
  searchIndex = [];

  // Hytter
  if (Array.isArray(allCabins)) {
    const validCabins = allCabins.filter((c) => {
      const name = c.name || c.navn || c.title;
      return typeof name === "string" && name.trim() !== "";
    });

    console.log("Gyldige hytter:", validCabins.length);

    searchIndex.push(
      ...validCabins.map((c) => ({
        label: (c.name || c.navn || c.title).trim(),
        type: "hytte",
        ref: c,
      }))
    );
  } else {
    console.warn("âš ï¸ allCabins er ikke en array:", allCabins);
  }

  // Tettsteder
  if (Array.isArray(allPlaces)) {
    const validPlaces = allPlaces.filter((p) => {
      const name = p.name || p.navn || p.title;
      return typeof name === "string" && name.trim() !== "";
    });

    console.log("Gyldige tettsteder:", validPlaces.length);

    searchIndex.push(
      ...validPlaces.map((p) => ({
        label: (p.name || p.navn || p.title).trim(),
        type: "sted",
        ref: p,
      }))
    );
  } else {
    console.warn("âš ï¸ allPlaces er ikke en array:", allPlaces);
  }

  console.log("âœ… SÃ¸keindeks bygget:", searchIndex.length, "elementer");
}

// --------------------------------------------------
// SÃ˜K â€“ INPUT & TASTATUR
// --------------------------------------------------
function initSearch() {
  const searchInput = document.getElementById("searchBox");
  if (!searchInput) {
    console.warn("Fant ikke sÃ¸kefeltet med ID 'searchBox'");
    return;
  }

  // Live forslag
  searchInput.addEventListener("input", () => {
    const query = searchInput.value.trim().toLowerCase();
    if (query.length < 2) {
      clearSuggestions();
      return;
    }

    const matches = searchIndex.filter((item) =>
      item.label.toLowerCase().includes(query)
    );
    renderSuggestions(matches);
  });

  // Piltaster/enter
  searchInput.addEventListener("keydown", (e) => {
    const suggestionsEl = document.getElementById("autocomplete");
    const items = suggestionsEl
      ? Array.from(suggestionsEl.querySelectorAll(".suggestion-item"))
      : [];

    if (e.key === "ArrowDown") {
      e.preventDefault();
      if (items.length === 0) return;
      suggestionActiveIndex = (suggestionActiveIndex + 1) % items.length;
      updateSuggestionHighlight(items);
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      if (items.length === 0) return;
      suggestionActiveIndex =
        (suggestionActiveIndex - 1 + items.length) % items.length;
      updateSuggestionHighlight(items);
    } else if (e.key === "Enter") {
      e.preventDefault();
      if (
        suggestionActiveIndex >= 0 &&
        suggestionActiveIndex < items.length
      ) {
        const label = items[suggestionActiveIndex].dataset.label;
        handleSearch(label);
      } else {
        const query = searchInput.value.trim().toLowerCase();
        if (query.length >= 2) {
          handleSearch(query);
        }
      }
    } else if (e.key === "Escape") {
      clearSuggestions();
    }
  });

  console.log("SÃ¸kefunksjon aktivert");
}

// --------------------------------------------------
// VIS FORSLAG
// --------------------------------------------------
function renderSuggestions(matches) {
  const suggestionsEl = document.getElementById("autocomplete");
  if (!suggestionsEl) return;

  suggestionsEl.innerHTML = "";

  if (!matches || matches.length === 0) {
    suggestionsEl.style.display = "none";
    suggestionActiveIndex = -1;
    return;
  }

  suggestionsEl.style.display = "block";
  suggestionActiveIndex = -1;

  matches.slice(0, 10).forEach((item) => {
    const div = document.createElement("div");
    div.className = "suggestion-item";
    div.textContent = `${item.label} (${item.type})`;
    div.dataset.label = item.label;

    div.addEventListener("mousedown", () => {
      handleSearch(item.label);
    });

    suggestionsEl.appendChild(div);
  });
}

function updateSuggestionHighlight(items) {
  items.forEach((item, index) => {
    if (index === suggestionActiveIndex) item.classList.add("active");
    else item.classList.remove("active");
  });
}

function clearSuggestions() {
  const suggestionsEl = document.getElementById("autocomplete");
  if (!suggestionsEl) return;
  suggestionsEl.innerHTML = "";
  suggestionsEl.style.display = "none";
  suggestionActiveIndex = -1;
}

// --------------------------------------------------
// HANDLE SEARCH
// --------------------------------------------------
function handleSearch(queryOrLabel) {
  if (!queryOrLabel || queryOrLabel.trim().length < 2) {
    console.warn("Ugyldig sÃ¸kestreng:", queryOrLabel);
    return;
  }

  const query = queryOrLabel.trim().toLowerCase();

  // 1. PrÃ¸v Ã¥ finne i sÃ¸keindeks (eksakt label)
  let matchItem =
    searchIndex.find((item) => item.label.toLowerCase() === query) || null;

  // 2. Hvis ikke eksakt i indeks: prÃ¸v Ã¥ finne i places/cabins
  if (!matchItem) {
    const placeMatch = allPlaces.find((p) => {
      const name = (p.name || p.navn || p.title || "").toLowerCase();
      const kommune = (p.kommune || p.municipality || "").toLowerCase();
      return name === query || kommune === query;
    });

    if (placeMatch) {
      matchItem = { type: "sted", ref: placeMatch };
    }
  }

  if (!matchItem) {
    console.warn("Fant ikke sted:", query);
    return;
  }

  const obj = matchItem.ref;
  const coords = getLatLon(obj);

  if (!coords) {
    console.warn("Ugyldige koordinater for:", obj);
    return;
  }

  const navn = obj.name || obj.title || obj.navn || "Uten navn";

  console.log("Fant sted:", navn);

  map.setView([coords.lat, coords.lon], 12);
  const marker =
    matchItem.type === "hytte"
      ? L.marker([coords.lat, coords.lon], { icon: cabinIcon }).addTo(map)
      : L.marker([coords.lat, coords.lon]).addTo(map);

  marker.bindPopup(navn).openPopup();
  marker.on("click", () => showInfo(obj));
}

// --------------------------------------------------
// INFOBOKS
// --------------------------------------------------
function showInfo(place) {
  const infoBox = document.getElementById("infoBox");
  const titleEl = document.getElementById("info-title");
  const contentEl = document.getElementById("info-content");

  if (!infoBox || !titleEl || !contentEl) {
    console.warn("Infoboks-elementer mangler i DOM");
    return;
  }

  const name = place.name || place.navn || place.title || "Uten navn";
  const municipality =
    place.municipality || place.kommune || "Ukjent kommune";
  const county = place.county || place.fylke || "Ukjent fylke";
  const website = place.website || null;

  titleEl.textContent = name;

  let html = `<p><strong>Kommune:</strong> ${municipality}</p>
              <p><strong>Fylke:</strong> ${county}</p>`;

  if (website) {
    html += `<p><a href="${website}" target="_blank">Nettside</a></p>`;
  }

  contentEl.innerHTML = html;
  infoBox.style.display = "block";
}